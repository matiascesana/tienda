<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tienda de Promociones - Distribuidora</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f6f9;
      margin: 0;
      padding: 0;
    }

    header {
      background: #3498db;
      color: white;
      padding: 15px;
      text-align: center;
      font-size: 22px;
      font-weight: bold;
    }

    main {
      max-width: 1100px;
      margin: 20px auto;
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    select, input[type="text"] {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }

    .productos-container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-top: 20px;
      justify-content: flex-start;
    }

    .promo-card {
      width: 200px;
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      background: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: 0.2s;
    }

    .promo-card:hover {
      box-shadow: 0 6px 15px rgba(0,0,0,0.15);
      transform: translateY(-2px);
    }

    .promo-card img {
      width: 100%;
      height: 140px;
      object-fit: cover;
      border-radius: 8px;
      margin-bottom: 8px;
    }

    .promo-card h3 {
      font-size: 15px;
      margin: 0 0 5px 0;
      text-align: center;
    }

    .promo-card p {
      color: #e74c3c;
      font-weight: bold;
      margin: 5px 0;
    }

    .promo-card button {
      background: #27ae60;
      color: #fff;
      border: none;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      margin-top: auto;
    }

    .promo-card button:hover {
      background: #219150;
    }

    #carritoResumen {
      margin-top: 30px;
      background: #f8f8f8;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 16px;
    }

    #carritoLista div {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 6px 0;
    }

    #carritoLista span {
      font-weight: bold;
      color: #333;
    }

    .carrito-btns button {
      margin: 0 3px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      padding: 3px 6px;
    }

    .carrito-btns button:hover {
      background: #2c80ba;
    }

    .btn-eliminar {
      background: #e74c3c !important;
    }

    .btn-confirmar {
      width: 100%;
      padding: 12px;
      margin-top: 10px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
    }

    .btn-confirmar:hover {
      background: #0056b3;
    }

    footer {
      text-align: center;
      padding: 15px;
      font-size: 14px;
      color: #777;
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

</head>

<body>
  <header style="display: flex; align-items: center; justify-content: center; gap: 10px;">
    <img src="https://ejbqlejlgprvwzrptojo.supabase.co/storage/v1/object/public/promo_images/logodistribuidora.png" 
         alt="Logo Distribuidora" 
         style="height: 100px;">
    üõçÔ∏è Tienda de Promociones de Distribuidora Allana
  </header>

  <main>
    <h3>üõí Mi Pedido (<span id="carritoCount">0</span>)</h3>
    <div id="carritoLista"><span style="color:#888;">No hay productos seleccionados</span></div>
    <hr>
    <p><b>Total:</b> <span id="carritoTotal">$0.00</span></p>

    <h3>Datos del Cliente</h3>
    <input id="clienteNombre" type="text" placeholder="Nombre y Apellido" required>
    <select id="clienteLocalidad" required>
      <option value="">Seleccionar localidad...</option>
    </select>

    <button class="btn-confirmar" onclick="confirmarPedido()">Confirmar y Enviar Pedido</button>
    <hr>

    <h2>Seleccione una Categor√≠a</h2>
    <select id="categoriaSelect" onchange="cargarPromosPorCategoria()">
      <option value="">Seleccionar categor√≠a...</option>
    </select>

    <h3>Buscar Promoci√≥n</h3>
    <input id="busquedaPromo" type="text" placeholder="Escriba el nombre de la promoci√≥n...">

    <div id="productosContainer" class="productos-container"></div>

    <div id="carritoResumen"></div>
  </main>

  <footer>Distribuidora Allana ¬© 2025</footer>

  <!-- Bot√≥n de WhatsApp -->
  <a href="https://wa.me/5493854784659?text=Hola%20te%20escribo%20de%20tu%20p√°gina%20de%20pedidos" 
     target="_blank" 
     style="
       position: fixed;
       bottom: 20px;
       right: 20px;
       background-color: #25D366;
       color: white;
       border-radius: 50%;
       width: 60px;
       height: 60px;
       display: flex;
       justify-content: center;
       align-items: center;
       text-decoration: none;
       font-size: 30px;
       box-shadow: 0 4px 8px rgba(0,0,0,0.3);
       z-index: 1000;
     ">
    <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" 
         alt="WhatsApp" style="width:60px; height:60px;">
  </a>

  <!-- Modal de confirmaci√≥n PDF -->
  <div id="modalPDF" style="
      display:none;
      position:fixed;
      top:0; left:0;
      width:100%; height:100%;
      background: rgba(0,0,0,0.5);
      justify-content:center;
      align-items:center;
      z-index:2000;
  ">
    <div style="
    background:white;
    padding:30px;
    border-radius:15px;
    max-width:450px;
    width:90%;
    text-align:center;
    box-shadow:0 6px 18px rgba(0,0,0,0.3);
    display:flex;
    flex-direction:column;
    gap:20px;
    align-items:center;
">
  <p style="font-size:18px;">‚úÖ Pedido enviado correctamente.<br>¬øDesea descargar el PDF con el detalle del pedido?</p>
  <div style="display:flex; gap:20px; width:100%; justify-content:center;">
    <button onclick="descargarPDF()" style="
      flex:1;
      padding:12px;
      font-size:16px;
      background:#27ae60;
      color:white;
      border:none;
      border-radius:8px;
      cursor:pointer;
      transition:0.2s;
    " onmouseover="this.style.background='#219150'" onmouseout="this.style.background='#27ae60'">S√≠</button>

    <button onclick="cerrarModalPDF()" style="
      flex:1;
      padding:12px;
      font-size:16px;
      background:#e74c3c;
      color:white;
      border:none;
      border-radius:8px;
      cursor:pointer;
      transition:0.2s;
    " onmouseover="this.style.background='#c0392b'" onmouseout="this.style.background='#e74c3c'">No</button>
  </div>
</div>


  <script>
    const SUPABASE_URL = "https://ejbqlejlgprvwzrptojo.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVqYnFsZWpsZ3Bydnd6cnB0b2pvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwMjkwMjIsImV4cCI6MjA3MjYwNTAyMn0.9fVItJka0MN3nlfowVudIE0AuNmfTJGQcbbqpau2Th8";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let carritoCliente = [];
    let todasLasPromos = [];
    let pedidoTemp = [];

    // ================== CARGA CATEGOR√çAS ==================
    async function cargarCategorias() {
      const { data, error } = await supabase.from("categorias").select("*").order("id");
      if (error) return console.error(error);

      const select = document.getElementById("categoriaSelect");
      select.innerHTML = '<option value="">Seleccionar categor√≠a...</option>';
      data.forEach(cat => {
        const opt = document.createElement("option");
        opt.value = cat.id;
        opt.textContent = cat.nombre;
        select.appendChild(opt);
      });
    }

    // ================== CARGA LOCALIDADES ==================
    async function cargarLocalidades() {
      const { data, error } = await supabase.from("localidades").select("*").order("nombre", { ascending: true });
      if (error) return console.error(error);

      const select = document.getElementById("clienteLocalidad");
      select.innerHTML = '<option value="">Seleccionar localidad...</option>';
      data.forEach(loc => {
        const opt = document.createElement("option");
        opt.value = loc.id;
        opt.textContent = loc.nombre;
        select.appendChild(opt);
      });
    }

    // ================== CARGA PROMOS POR CATEGOR√çA ==================
    async function cargarPromosPorCategoria() {
      const catId = document.getElementById("categoriaSelect").value;
      const cont = document.getElementById("productosContainer");
      cont.innerHTML = "";

      if (!catId) return;

      const { data: promos, error } = await supabase.from("promociones").select("*").eq("categoria_id", catId);
      if (error) {
        cont.innerHTML = "<p style='color:red;'>Error al cargar productos.</p>";
        return;
      }

      todasLasPromos = promos;
      renderPromos(promos);
    }

    // ================== FILTRAR POR NOMBRE ==================
    document.getElementById("busquedaPromo").addEventListener("input", async (e) => {
      const texto = e.target.value.trim().toLowerCase();
      const catId = document.getElementById("categoriaSelect").value;
      const cont = document.getElementById("productosContainer");

      if (texto.length === 0 && !catId) {
        cont.innerHTML = "<p style='color:#888;'>Seleccione una categor√≠a o busque una promoci√≥n.</p>";
        return;
      }

      let query = supabase.from("promociones").select("*");

      if (catId) query = query.eq("categoria_id", catId);
      if (texto.length > 0) query = query.ilike("nombre", `%${texto}%`);

      const { data: promos, error } = await query;
      if (error) {
        cont.innerHTML = "<p style='color:red;'>Error al buscar promociones.</p>";
        console.error(error);
        return;
      }

      renderPromos(promos);
    });

    // ================== RENDER PROMOS ==================
    function renderPromos(promos) {
      const cont = document.getElementById("productosContainer");
      cont.innerHTML = "";

      if (!promos || promos.length === 0) {
        cont.innerHTML = "<p style='color:#888;'>No hay productos que coincidan.</p>";
        return;
      }

      promos.forEach(p => {
        const imgURL = p.imagen
          ? `https://ejbqlejlgprvwzrptojo.supabase.co/storage/v1/object/public/promo_images/${p.imagen}`
          : "https://via.placeholder.com/200x140?text=Sin+Imagen";

        const card = document.createElement("div");
        card.className = "promo-card";

        const nombreEscapado = p.nombre.replace(/'/g, "\\'");
        card.innerHTML = `
          <img src="${imgURL}" alt="${nombreEscapado}">
          <h3>${p.nombre}</h3>
          <p>$${p.precio.toFixed(2)}</p>
          <button onclick="agregarAlCarrito(${p.id}, '${nombreEscapado}', ${p.precio})">Agregar</button>
        `;

        cont.appendChild(card);
      });
    }

    // ================== CARRITO ==================
    function agregarAlCarrito(id, nombre, precio) {
      const item = carritoCliente.find(i => i.id === id);
      if (item) item.cantidad++;
      else carritoCliente.push({ id, nombre, precio, cantidad: 1 });
      renderCarrito();
    }

    function modificarCantidad(id, delta) {
      const item = carritoCliente.find(i => i.id === id);
      if (!item) return;
      item.cantidad += delta;
      if (item.cantidad <= 0) carritoCliente = carritoCliente.filter(p => p.id !== id);
      renderCarrito();
    }

    function eliminarDelCarrito(id) {
      carritoCliente = carritoCliente.filter(p => p.id !== id);
      renderCarrito();
    }

    function renderCarrito() {
      const lista = document.getElementById("carritoLista");
      const count = document.getElementById("carritoCount");
      const totalEl = document.getElementById("carritoTotal");

      lista.innerHTML = "";
      let total = 0;

      carritoCliente.forEach(p => {
        total += p.precio * p.cantidad;
        const row = document.createElement("div");
        row.innerHTML = `
          <span>${p.nombre} (${p.cantidad}x)</span>
          <div class="carrito-btns">
            <button onclick="modificarCantidad(${p.id}, -1)">‚àí</button>
            <button onclick="modificarCantidad(${p.id}, 1)">+</button>
            <button class="btn-eliminar" onclick="eliminarDelCarrito(${p.id})">‚úï</button>
          </div>
        `;
        lista.appendChild(row);
      });

      count.textContent = carritoCliente.length;
      totalEl.textContent = "$" + total.toFixed(2);

      if (carritoCliente.length === 0)
        lista.innerHTML = '<span style="color:#888;">No hay productos seleccionados</span>';
    }

    // ================== PEDIDO ==================
    async function confirmarPedido() {
      const nombre = document.getElementById("clienteNombre").value.trim();
      const localidad = document.getElementById("clienteLocalidad").value;

      if (!nombre || !localidad || carritoCliente.length === 0) {
        alert("Complete los datos y agregue al menos un producto.");
        return;
      }

      const total = carritoCliente.reduce((acc, p) => acc + p.precio * p.cantidad, 0);

      const pedido = {
        cliente: nombre,
        localidad_id: localidad,
        productos: carritoCliente,
        total: total,
        created_at: new Date().toISOString(),
        estado: "pendiente"
      };

      const { error } = await supabase.from("pedidos").insert(pedido);
      if (error) {
        alert("Error al enviar el pedido: " + error.message);
        console.error(error);
      } else {
        pedidoTemp = [...carritoCliente];
        abrirModalPDF();
      }
    }

    function abrirModalPDF() {
      document.getElementById("modalPDF").style.display = "flex";
    }

    function cerrarModalPDF() {
      document.getElementById("modalPDF").style.display = "none";
      alert("‚úÖ Su pedido se envi√≥ correctamente.");
      document.getElementById("clienteNombre").value = "";
      document.getElementById("clienteLocalidad").value = "";
      document.getElementById("categoriaSelect").value = "";
      document.getElementById("productosContainer").innerHTML = "";
      document.getElementById("busquedaPromo").value = "";
      carritoCliente = [];
      renderCarrito();
    }

    async function descargarPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      // Logo
      const logoUrl = "https://ejbqlejlgprvwzrptojo.supabase.co/storage/v1/object/public/promo_images/logodistribuidora.png";
      const img = new Image();
      img.src = logoUrl;

      img.onload = () => {
  const logoWidth = 60; // nuevo ancho m√°s amplio
  const logoHeight = (img.height / img.width) * logoWidth; // mantiene proporci√≥n
  doc.addImage(img, 'PNG', 15, 10, logoWidth, logoHeight);
  
  doc.setFontSize(18);
  doc.text("Pedido de Cliente", 150, 25, { align: 'right' });

        const fecha = new Date().toLocaleString("es-AR");
        doc.setFontSize(12);
        doc.text(`Cliente: ${document.getElementById("clienteNombre").value}`, 15, 60);
        const localidadSelect = document.getElementById("clienteLocalidad");
        const localidadText = localidadSelect.options[localidadSelect.selectedIndex].text;
        doc.text(`Localidad: ${localidadText}`, 15, 68);
        doc.text(`Fecha: ${fecha}`, 15, 76);

        const tabla = pedidoTemp.map(p => [
          p.nombre,
          p.cantidad.toString(),
          `$${p.precio.toFixed(2)}`,
          `$${(p.precio * p.cantidad).toFixed(2)}`
        ]);

        doc.autoTable({
          head: [['Producto', 'Cantidad', 'Precio', 'Subtotal']],
          body: tabla,
          startY: 90,
          styles: { fontSize: 11 },
          headStyles: { fillColor: [230, 230, 230] }
        });

        const total = pedidoTemp.reduce((acc, p) => acc + p.precio * p.cantidad, 0);
        const finalY = doc.lastAutoTable.finalY || 90;
        doc.setFontSize(12);
        doc.setFont(undefined, 'bold');
        doc.text(`TOTAL: $${total.toFixed(2)}`, 150, finalY + 10, { align: 'right' });

        doc.save("Pedido.pdf");
        pedidoTemp = [];
        cerrarModalPDF();
      };
    }

    // ================== INICIALIZACI√ìN ==================
    cargarCategorias();
    cargarLocalidades();
  </script>

</body>
</html>
