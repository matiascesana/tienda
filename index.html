<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Tienda de Pedidos - Distribuidora</title>
  <link rel="manifest" href="manifest.json">

<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f0f2f5;
    margin: 0;
    padding: 0;
    overflow-x: hidden;
  }

  header {
    background: linear-gradient(90deg, #3498db, #2980b9);
    color: white;
    padding: 20px;
    text-align: center;
    font-size: 22px;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
    flex-wrap: wrap;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  }

  header img {
    height: 80px;
    max-width: 40%;
    object-fit: contain;
    border-radius: 10px;
    border: 2px solid white;
  }

  main {
    max-width: 1000px;
    margin: 25px auto;
    background: white;
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.1);
  }

  select, input[type="text"] {
    width: 100%;
    padding: 14px;
    margin-top: 12px;
    border: 1px solid #ccc;
    border-radius: 8px;
    font-size: 16px;
    transition: 0.2s;
  }

  select:focus, input[type="text"]:focus {
    border-color: #3498db;
    outline: none;
    box-shadow: 0 0 5px rgba(52,152,219,0.5);
  }

  .productos-container {
    display: flex;
    flex-wrap: wrap;
    gap: 18px;
    margin-top: 20px;
    justify-content: flex-start;
  }

  .promo-card {
    width: 48%;
    max-width: 220px;
    border: 1px solid #ddd;
    border-radius: 12px;
    padding: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    background: #fff;
    display: flex;
    flex-direction: column;
    align-items: center;
    transition: 0.3s;
  }

  .promo-card:hover {
    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    transform: translateY(-3px);
  }

  .promo-card img {
    width: 100%;
    height: 150px;
    object-fit: cover;
    border-radius: 10px;
    margin-bottom: 10px;
    border: 1px solid #ccc;
  }

  .promo-card h3 {
    font-size: 15px;
    margin: 0 0 8px 0;
    text-align: center;
  }

  .promo-card p {
    margin: 5px 0;
    font-weight: bold;
  }

  .promo-card button {
    background: #27ae60;
    color: #fff;
    border: none;
    padding: 12px;
    border-radius: 10px;
    cursor: pointer;
    margin-top: auto;
    font-size: 15px;
    width: 100%;
    transition: 0.2s;
  }

  .promo-card button:hover {
    background: #1e8449;
  }

  #consultarPedidosCliente {
    background-color: #f39c12 !important;
    color: white !important;
    border: none !important;
    transition: background-color 0.2s;
  }

  #consultarPedidosCliente:hover {
    background-color: #e67e22 !important;
  }

  #carritoResumen {
    margin-top: 20px;
    background: #f9f9f9;
    border: 1px solid #ddd;
    border-radius: 10px;
    padding: 15px;
    max-height: 320px;
    overflow-y: auto;
  }

  #carritoLista div {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 8px 0;
    flex-wrap: wrap;
    padding: 8px;
    border-radius: 8px;
    border: 1px solid #eee;
    background: #fff;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
  }

  #carritoLista span {
    font-weight: bold;
    color: #333;
  }

  .carrito-btns button {
    margin: 3px 2px;
    background: #3498db;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    padding: 6px 10px;
    font-size: 14px;
    transition: 0.2s;
  }

  .carrito-btns button:hover {
    background: #2c80ba;
  }

  .btn-eliminar {
    background: #e74c3c !important;
  }

  .btn-confirmar {
    width: 100%;
    padding: 16px;
    margin-top: 15px;
    background: #27ae60;
    color: white;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    font-size: 16px;
    font-weight: bold;
    transition: 0.2s;
  }

  .btn-confirmar:hover {
    background: #0056b3;
  }

  footer {
    text-align: center;
    padding: 20px;
    font-size: 14px;
    color: #777;
  }

  /* Modal PDF */
  #modalPDF {
    display: none;
    position: fixed;
    top:0; left:0;
    width:100%; height:100%;
    background: rgba(0,0,0,0.65);
    justify-content:center;
    align-items:center;
    z-index:2000;
    padding: 15px;
    box-sizing: border-box;
  }

  #modalPDF .modal-content {
    background: white;
    padding: 28px;
    border-radius: 14px;
    max-width: 420px;
    width: 100%;
    text-align: center;
    box-shadow: 0 8px 20px rgba(0,0,0,0.3);
  }

  #modalPDF .modal-content button {
    padding: 14px 22px;
    margin: 12px;
    font-size:16px;
    border-radius: 10px;
    cursor: pointer;
    border:none;
    transition: 0.2s;
  }

  #modalPDF .modal-content button:nth-child(2) {
    background:#e74c3c;
    color:white;
  }

  #modalPDF .modal-content button:nth-child(3) {
    background:#27ae60;
    color:white;
  }

  /* Modal para la imagen ampliada */
  #modalImagen {
    display: none;
    position: fixed !important;
    z-index: 99999 !important;
    left: 0 !important;
    top: 0 !important;
    width: 100%;
    height: 100%;
    overflow: auto; 
    background-color: rgba(0,0,0,0.9);
    align-items: center;
    justify-content: center;
  }

  #modalImagen .modal-content-img {
    position: relative;
    margin: auto;
    padding: 20px;
    background-color: #fefefe;
    border-radius: 8px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    text-align: center;
    max-width: 90%;
    max-height: 90%;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  #modalImagen img {
    max-width: 100%;
    max-height: 75vh;
    display: block;
    margin: 0 auto 15px auto;
    border-radius: 8px;
  }

  #modalImagen .close-button {
    background-color: #e74c3c;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 16px;
    transition: background-color 0.2s;
  }

  #modalImagen .close-button:hover {
    background-color: #c0392b;
  }

  @media (max-width: 800px) {
    #consultarPedidosCliente {
      font-size: 18px;
      padding: 12px 16px;
    }
  }

  @media (max-width: 480px) {
    .promo-card {
      width: 100%;
    }
    header img {
      max-width: 60%;
      height: auto;
    }
    header {
      font-size: 18px;
    }
  }

  .quantity-controls-card {
    display: flex;
    align-items: center;
    justify-content: space-between;
    border: 1px solid #ccc;
    border-radius: 8px;
    overflow: hidden;
    height: 35px;
    max-width: 120px;
    margin: 0 auto;
  }

  .btn-cantidad-menos, .btn-cantidad-mas {
    background: #3498db;
    color: white;
    border: none;
    padding: 0;
    width: 35px;
    height: 100%;
    cursor: pointer;
    font-size: 18px;
    font-weight: bold;
    transition: background-color 0.2s;
    line-height: 1;
  }

  .btn-cantidad-menos:hover, .btn-cantidad-mas:hover {
    background-color: #2980b9;
  }

  .cantidad-display-card {
    flex-grow: 1;
    text-align: center;
    font-weight: bold;
    font-size: 16px;
    color: #333;
    padding: 0 5px;
  }

  .add-to-cart-btn {
    background: #27ae60;
    color: #fff;
    border: none;
    padding: 10px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 15px;
    width: 100%;
    transition: 0.2s;
  }

  .add-to-cart-btn:hover {
    background: #1e8449;
  }

.item-control {
  display: flex;
  align-items: center;
  padding: 12px;
  border-bottom: 1px solid #eee;
  gap: 15px;
}

.item-control input[type="checkbox"] {
  width: 22px;
  height: 22px;
  cursor: pointer;
}

.item-control label {
  flex: 1;
  font-size: 16px;
  cursor: pointer;
}

.item-control.checked {
  background-color: #f0fdf4;
  color: #888;
  text-decoration: line-through;
}  
</style>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</head>

<body>
<header>
  <img src="https://ejbqlejlgprvwzrptojo.supabase.co/storage/v1/object/public/promo_images/logodistribuidora.png" alt="Logo Distribuidora">
  üõçÔ∏è Tienda de Promociones de Distribuidora Allana
</header>

<main>
  <h3>üõí Mi Pedido (<span id="carritoCount">0</span>)</h3>
  <div id="carritoLista"><span style="color:#888;">No hay productos seleccionados</span></div>
  <hr>
  <p><b>Total:</b> <span id="carritoTotal">$0.00</span></p>

  <h3>Datos del Cliente</h3>
  <div style="display:flex;gap:10px; flex-wrap:wrap;">
    <input id="clienteNombre" type="text" placeholder="Nombre y Apellido" required style="flex:1;">
    <button onclick="buscarClientePorNombre()" id="buscarClienteBtn" style="background:#f39c12; color:white; border:none; border-radius:8px; padding:12px 16px; margin-top:12px; cursor:pointer;">Buscar Cliente</button>
  </div>

  <div style="display:flex;gap:10px; flex-wrap:wrap;">
    <input id="dni" type="text" placeholder="DNI sin puntos" style="flex:1;">
    <button onclick="consultarPedidosCliente()" id="consultarPedidosCliente" style="border-radius: 8px; padding: 12px 16px; margin-top: 12px; cursor: pointer;">Consultar pedidos ya cargados</button>
  </div>

  <select id="clienteLocalidad" required>
    <option value="">Seleccionar localidad...</option>
  </select>

  <button class="btn-confirmar" onclick="confirmarPedido()">Confirmar y Enviar Pedido</button>
  <hr>

  <h2>Seleccione una Categor√≠a</h2>
  <select id="categoriaSelect" onchange="cargarPromosPorCategoria()">
    <option value="">Seleccionar categor√≠a...</option>
  </select>

  <h3>Buscar Promoci√≥n</h3>
  <input id="busquedaPromo" type="text" placeholder="Escriba el nombre de la promoci√≥n...">

  <div id="productosContainer" class="productos-container"></div>

  <div id="carritoResumen"></div>
</main>

<footer>Distribuidora Allana ¬© 2025</footer>

<div id="modalPDF">
  <div class="modal-content">
    <p>‚úÖ Pedido enviado correctamente.</p>
    <div style="display: flex; flex-direction: column; gap: 10px;">
      <button onclick="abrirControlPedido()" style="background:#3498db; color:white;">üîç Ver y controlar el pedido</button>
      <div style="display: flex; justify-content: center; gap: 10px;">
        <button onclick="cerrarModalPDF()" style="background:#e74c3c; color:white;">Cerrar</button>
        <button onclick="descargarPDF()" style="background:#27ae60; color:white;">Descargar PDF directo</button>
      </div>
    </div>
  </div>
</div>

<div id="modalControlPedido" style="display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); justify-content:center; align-items:center; z-index:3000; padding: 15px;">
  <div class="modal-content" style="background: white; padding: 25px; border-radius: 14px; max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto;">
    <h2 style="margin-top:0;">üìã Control de Preparaci√≥n</h2>
    <p style="font-size: 14px; color: #555;">Marque los productos a medida que los separa:</p>
    <hr>
    <div id="listaControlCheck" style="text-align: left; margin: 20px 0;">
      </div>
    <hr>
    <div id="contenedorBotonesControl" style="display: flex; flex-direction: column; gap: 10px;">
        <button id="btnFinalizarControl" disabled onclick="descargarPDFDesdeControl()" style="background:#ccc; color:white; padding: 15px; border-radius: 10px; border:none; font-weight:bold; cursor: not-allowed; font-size: 16px;">
            FINALIZAR Y DESCARGAR PDF
        </button>
        <button onclick="cerrarControlPedido()" style="background:none; border:none; color:#e74c3c; cursor:pointer; text-decoration: underline;">Cancelar</button>
    </div>
  </div>
</div>

  

<div id="modalImagen">
  <div class="modal-content-img">
    <button class="close-button" onclick="cerrarModalImagen()">Cerrar</button>
    <img id="imagenModalAmpliada" src="" alt="Imagen Ampliada">
  </div>
</div>

<a href="https://wa.me/5493854784659?text=Hola%20te%20escribo%20de%20tu%20p√°gina%20de%20pedidos" target="_blank"
   style="position: fixed; bottom: 20px; right: 20px; background-color: #25D366; color: white; border-radius: 50%; width: 60px; height: 60px; display: flex; justify-content: center; align-items: center; text-decoration: none; font-size: 30px; box-shadow: 0 4px 8px rgba(0,0,0,0.3); z-index: 1000;">
  <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="WhatsApp" style="width:60px; height:60px;">
</a>

<script>
// --- CONFIGURACI√ìN DE SUPABASE ---
const SUPABASE_URL = "https://ejbqlejlgprvwzrptojo.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVqYnFsZWpsZ3Bydnd6cnB0b2pvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwMjkwMjIsImV4cCI6MjA3MjYwNTAyMn0.9fVItJka0MN3nlfowVudIE0AuNmfTJGQcbbqpau2Th8";

// Usamos 'sb' para evitar conflictos con la variable global 'supabase' que inyecta la CDN
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let todasLasPromos = [];
let pedidoTemp = [];
let pedidoExistenteId = null;

// ================== CARGA CATEGOR√çAS ==================
async function cargarCategorias() {
  const { data, error } = await sb
    .from("categorias")
    .select("*")
    .order("nombre", { ascending: true });

  if (error) {
    console.error("Error al cargar categor√≠as:", error);
    return; 
  }
  
  const select = document.getElementById("categoriaSelect");
  select.innerHTML = '<option value="">Seleccionar categor√≠a...</option>';
  
  data.forEach(cat => {
    const opt = document.createElement("option");
    opt.value = cat.id;
    opt.textContent = cat.nombre;
    select.appendChild(opt);
  });
}

// ================== BUSCAR CLIENTE POR NOMBRE ==================
async function buscarClientePorNombre() {
  const nombreBusqueda = document.getElementById("clienteNombre").value.trim();

  if (nombreBusqueda.length < 3) {
    alert("Ingrese al menos 3 letras del nombre o apellido para buscar.");
    return;
  }

  try {
    const { data: pedidos, error } = await sb
      .from("pedidos")
      .select("cliente, dni, localidad_id")
      .ilike("cliente", `%${nombreBusqueda}%`)
      .limit(20);

    if (error) throw error;
    if (!pedidos || pedidos.length === 0) {
      alert(`No se encontraron clientes con: "${nombreBusqueda}"`);
      return;
    }

    const clientesUnicos = [];
    const clientesVistos = new Set();
    pedidos.forEach(p => {
      const clave = `${p.cliente}-${p.dni}`;
      if (!clientesVistos.has(clave) && p.cliente && p.localidad_id) {
        clientesVistos.add(clave);
        clientesUnicos.push(p);
      }
    });

    if (clientesUnicos.length === 0) {
      alert("No se encontraron clientes v√°lidos.");
      return;
    }

    const modal = document.createElement("div");
    modal.style = "position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:flex;justify-content:center;align-items:center;z-index:2000;";
    const contenido = document.createElement("div");
    contenido.style = "background:white;padding:25px;border-radius:12px;max-width:500px;width:90%;text-align:left;max-height:80vh;overflow-y:auto;";
    contenido.innerHTML = `<h3 style="margin-top:0;">Seleccione el Cliente:</h3>`;
    
    clientesUnicos.forEach(c => {
      const btn = document.createElement("button");
      btn.style = "display:block;width:100%;margin:10px 0;padding:12px;background:#3498db;color:white;border:none;border-radius:8px;cursor:pointer;font-size:15px;text-align:left;";
      btn.textContent = `${c.cliente} (DNI: ${c.dni || 'No Asignado'})`;
      
      btn.onclick = () => {
        document.getElementById("clienteNombre").value = c.cliente;
        document.getElementById("dni").value = c.dni || '';
        document.getElementById("clienteLocalidad").value = c.localidad_id;
        document.body.removeChild(modal);
      };
      contenido.appendChild(btn);
    });

    const cancelar = document.createElement("button");
    cancelar.textContent = "Cerrar B√∫squeda";
    cancelar.style = "margin-top:20px;padding:12px;width:100%;background:#e74c3c;color:white;border:none;border-radius:8px;cursor:pointer;font-size:15px;";
    cancelar.onclick = () => document.body.removeChild(modal);
    contenido.appendChild(cancelar);

    modal.appendChild(contenido);
    document.body.appendChild(modal);

  } catch (err) {
    console.error(err);
    alert("Error al consultar clientes.");
  }
}

// ================== CARGA LOCALIDADES ==================
async function cargarLocalidades() {
  const { data, error } = await sb.from("localidades").select("*").order("nombre", { ascending: true });
  if (error) return console.error(error);
  const select = document.getElementById("clienteLocalidad");
  select.innerHTML = '<option value="">Seleccionar localidad...</option>';
  data.forEach(loc => {
    const opt = document.createElement("option");
    opt.value = loc.id;
    opt.textContent = loc.nombre;
    select.appendChild(opt);
  });
}

// ================== MODAL IMAGEN ==================
function abrirModalImagen(imgUrl) {
  document.getElementById("imagenModalAmpliada").src = imgUrl;
  document.getElementById("modalImagen").style.display = "flex";
}

function cerrarModalImagen() {
  document.getElementById("modalImagen").style.display = "none";
}

// ================== CARGA PROMOS ==================
async function cargarPromosPorCategoria() {
  const catId = document.getElementById("categoriaSelect").value;
  const cont = document.getElementById("productosContainer");
  cont.innerHTML = "";
  if (!catId) return;

  const { data: promos, error } = await sb
    .from("promociones")
    .select("*")
    .eq("categoria_id", catId);

  if (error) {
    cont.innerHTML = "<p style='color:red;'>Error al cargar productos.</p>";
    return;
  }

  promos.sort((a, b) => a.nombre.localeCompare(b.nombre, 'es', { sensitivity: 'base' }));
  todasLasPromos = promos;
  renderPromos(promos);
}

// ================== FILTRADO B√öSQUEDA ==================
let controlBusqueda = 0;
document.getElementById("busquedaPromo").addEventListener("input", async (e) => {
  const texto = e.target.value.trim().toLowerCase();
  const catId = document.getElementById("categoriaSelect").value;
  const cont = document.getElementById("productosContainer");
  const idControlActual = ++controlBusqueda;

  if (texto.length === 0 && !catId) {
    cont.innerHTML = "<p style='color:#888;'>Seleccione una categor√≠a o busque una promoci√≥n.</p>";
    return;
  }

  let query = sb.from("promociones").select("*");
  if (catId) query = query.eq("categoria_id", catId);
  if (texto.length > 0) query = query.ilike("nombre", `%${texto}%`);

  const { data: promos, error } = await query;
  if (idControlActual !== controlBusqueda) return;
  if (error) { cont.innerHTML = "<p style='color:red;'>Error al buscar promociones.</p>"; return; }
  renderPromos(promos);
});

// ================== RENDERIZADO TARJETAS ==================
function renderPromos(promos) {
  const cont = document.getElementById("productosContainer");
  cont.innerHTML = "";

  if (!promos || promos.length === 0) {
    cont.innerHTML = "<p style='color:#888;'>No hay productos que coincidan.</p>";
    return;
  }

  promos.forEach(p => {
    const imgURL = p.imagen
      ? `https://ejbqlejlgprvwzrptojo.supabase.co/storage/v1/object/public/promo_images/${p.imagen}`
      : "https://via.placeholder.com/200x140?text=Sin+Imagen";

    const card = document.createElement("div");
    card.className = "promo-card";
    const nombreEscapado = p.nombre.replace(/'/g, "\\'");
    
    const stock = p.stock || 0;
    let stockColor = '#27ae60';
    let stockText = `Stock: ${stock}`;

    if (stock < 5 && stock > 0) {
      stockColor = '#f39c12';
    } else if (stock === 0) {
      stockColor = '#e74c3c';
      stockText = '¬°AGOTADO!';
    }

    let precioHTML = "";
    if (p.precio_anterior && p.precio_anterior > p.precio) {
      const descuento = Math.round(((p.precio_anterior - p.precio) / p.precio_anterior) * 100);
      precioHTML = `
        <p style="margin: 5px 0; text-align:center;">
          <span style="text-decoration: line-through; color: #888; font-size: 13px;">$${p.precio_anterior.toFixed(2)}</span><br>
          <span style="color: #e74c3c; font-weight: bold; font-size: 15px;">$${p.precio.toFixed(2)}</span>
          <span style="color:#27ae60; font-size:13px; font-weight:bold;">(-${descuento}%)</span>
        </p>`;
    } else {
      precioHTML = `<p style="color: #e74c3c; font-weight: bold;">$${p.precio.toFixed(2)}</p>`;
    }
    
    const imgElement = document.createElement('img');
    imgElement.src = imgURL;
    imgElement.alt = nombreEscapado;
    imgElement.style.cursor = 'zoom-in';
    imgElement.addEventListener('click', () => abrirModalImagen(imgURL));
    
    card.innerHTML = `
      <h3>${p.nombre}</h3>
      <span style="font-size: 12px; font-weight: bold; color: ${stockColor}; margin-bottom: 5px;">${stockText}</span>
      ${precioHTML}
      <div style="display:flex; flex-direction:column; gap: 8px; width: 100%; margin: 5px 0 10px 0;">
        <div id="controls-container-${p.id}" class="quantity-controls-card">
          <button class="btn-cantidad-menos" onclick="cambiarCantidadCard(${p.id}, -1)">‚àí</button>
          <span id="cantidad-display-${p.id}" class="cantidad-display-card">1</span>
          <button class="btn-cantidad-mas" onclick="cambiarCantidadCard(${p.id}, 1)">+</button>
        </div>
        <button class="add-to-cart-btn" onclick="agregarAlCarritoDesdeCard(${p.id}, '${nombreEscapado}', ${p.precio}, ${p.precio_anterior || null})">Agregar</button>
      </div>`;
    
    card.prepend(imgElement);
    cont.appendChild(card);
  });
}

function cambiarCantidadCard(id, cambio) {
  const display = document.getElementById(`cantidad-display-${id}`);
  if (!display) return;
  let cantidadActual = parseInt(display.textContent, 10);
  let nuevaCantidad = cantidadActual + cambio;
  if (nuevaCantidad < 1) nuevaCantidad = 1;
  display.textContent = nuevaCantidad;
}

function agregarAlCarritoDesdeCard(id, nombre, precio, precio_anterior) {
  const cantidadDisplay = document.getElementById(`cantidad-display-${id}`);
  let cantidad = parseInt(cantidadDisplay.textContent, 10);
  if (isNaN(cantidad) || cantidad <= 0) cantidad = 1;

  carritoLista(id, nombre, precio, precio_anterior, cantidad);
  cantidadDisplay.textContent = 1;
}

function carritoLista(id, nombre, precio, precio_anterior = null, cantidadAAgregar = 1) { 
  const index = pedidoTemp.findIndex(item => item.id === id);
  if (index !== -1) {
    pedidoTemp[index].cantidad += cantidadAAgregar;
  } else {
    pedidoTemp.push({ id, nombre, precio, precio_anterior, cantidad: cantidadAAgregar });
  }
  renderCarritoCliente();
}

function modificarCantidad(id, cambio) {
  const producto = pedidoTemp.find(p => p.id === id);
  if (!producto) return;
  producto.cantidad += cambio;
  if (producto.cantidad <= 0) pedidoTemp = pedidoTemp.filter(p => p.id !== id);
  renderCarritoCliente();
}

function renderCarritoCliente() {
  const contenedor = document.getElementById("carritoLista");
  if (!contenedor) return;

  if (pedidoTemp.length === 0) {
    contenedor.innerHTML = "<span style='color:#888;'>üõí No hay productos seleccionados</span>";
    document.getElementById("carritoTotal").textContent = "$0.00";
    document.getElementById("carritoCount").textContent = "0";
    return;
  }

  contenedor.innerHTML = pedidoTemp.map(p => `
    <div style="display:flex;justify-content:space-between;align-items:center;margin:8px 0;padding:10px;border:1px solid #ccc;border-radius:10px; background:#fff;">
      <div style="flex:1; font-weight:bold; color:#333;">${p.nombre}</div>
      <div style="display:flex; align-items:center; gap:6px; border:1px solid #ddd; border-radius:6px; padding:2px 4px;">
        <button onclick="modificarCantidad(${p.id}, -1)" style="background:#e74c3c;color:white;border:none;border-radius:4px;padding:4px 8px; cursor:pointer;">‚àí</button>
        <span style="min-width:24px; text-align:center;">${p.cantidad}</span>
        <button onclick="modificarCantidad(${p.id}, 1)" style="background:#27ae60;color:white;border:none;border-radius:4px;padding:4px 8px; cursor:pointer;">+</button>
      </div>
      <div style="width:70px; text-align:right; font-weight:bold; color:#e74c3c;">
        $${(p.precio * p.cantidad).toFixed(2)}
      </div>
    </div>
  `).join("");

  const total = pedidoTemp.reduce((sum, p) => sum + p.precio * p.cantidad, 0);
  document.getElementById("carritoTotal").textContent = `$${total.toFixed(2)}`;
  document.getElementById("carritoCount").textContent = pedidoTemp.reduce((sum, p) => sum + p.cantidad, 0);
}

// ================== CONSULTA PEDIDOS DNI ==================
async function consultarPedidosCliente() {
  const dni = document.getElementById("dni").value.trim();
  if (!dni) { alert("Ingrese el DNI."); return; }

  try {
    const { data: pedidos, error } = await sb
      .from("pedidos")
      .select("id, created_at, total, productos, cliente, estado") 
      .ilike("dni", `%${dni}%`)
      .order("created_at", { ascending: false });

    if (error) throw error;
    if (!pedidos || pedidos.length === 0) {
      alert("No se encontr√≥ ning√∫n pedido.");
      return;
    }

    const modal = document.createElement("div");
    modal.style = "position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:flex;justify-content:center;align-items:center;z-index:2000;";
    const contenido = document.createElement("div");
    contenido.style = "background:white;padding:20px;border-radius:12px;max-width:400px;width:90%;text-align:left; max-height:80vh; overflow-y:auto;";
    contenido.innerHTML = `<h3>Pedidos encontrados:</h3>`;

    pedidos.forEach(p => {
      const fecha = new Date(p.created_at).toLocaleString("es-AR");
      const estadoTexto = p.estado === 'archivado' ? 'üî¥ ARCHIVADO' : 'üü¢ ACTIVO';
      const btn = document.createElement("button");
      btn.style = `display:block;width:100%;margin:8px 0;padding:12px;border:1px solid #ccc;border-radius:8px;cursor:pointer;background-color:${p.estado === 'archivado' ? '#f7dbdb' : '#e0f7e9'}`;
      btn.textContent = `[${estadoTexto}] - ${fecha} - $${p.total.toFixed(2)}`;
      
      btn.onclick = () => {
        pedidoTemp = [];
        pedidoExistenteId = p.id;
        if (Array.isArray(p.productos)) {
          p.productos.forEach(prod => {
            pedidoTemp.push({
              id: prod.id,
              nombre: prod.nombre,
              precio: prod.precio,
              precio_anterior: prod.precio_anterior,
              cantidad: prod.cantidad
            });
          });
        }
        renderCarritoCliente();
        document.body.removeChild(modal);
      };
      contenido.appendChild(btn);
    });

    const cerrar = document.createElement("button");
    cerrar.textContent = "Cerrar";
    cerrar.style = "margin-top:20px;padding:12px;width:100%;background:#e74c3c;color:white;border:none;border-radius:8px;";
    cerrar.onclick = () => document.body.removeChild(modal);
    contenido.appendChild(cerrar);
    modal.appendChild(contenido);
    document.body.appendChild(modal);

  } catch (err) {
    console.error(err);
    alert("Error al consultar pedidos.");
  }
}

// ================== CONFIRMAR PEDIDO ==================
async function confirmarPedido() {
  if (!document.getElementById("clienteNombre").value || !document.getElementById("clienteLocalidad").value) {
    alert("Complete el nombre y la localidad");
    return;
  }

  if (pedidoTemp.length === 0) {
    alert("No hay productos seleccionados");
    return;
  }

  const nombreCliente = document.getElementById("clienteNombre").value.trim();
  const localidadId = document.getElementById("clienteLocalidad").value;
  const totalCalculado = pedidoTemp.reduce((sum, p) => sum + p.precio * p.cantidad, 0);
  const dni = document.getElementById("dni").value.trim();

  try {
    if (pedidoExistenteId) {
      const { error } = await sb
        .from("pedidos")
        .update({ dni: dni, total: totalCalculado, productos: pedidoTemp })
        .eq("id", pedidoExistenteId);
      if (error) throw error;
    } else {
      const { data, error } = await sb
        .from("pedidos")
        .insert([{
          cliente: nombreCliente,
          dni: dni,
          localidad_id: localidadId,
          total: totalCalculado,
          productos: pedidoTemp,
          created_at: new Date().toISOString()
        }])
        .select();
      if (error) throw error;
      pedidoExistenteId = data[0].id;
    }

    for (const prod of pedidoTemp) {
      await sb.rpc('descontar_stock', {
        producto_id: prod.id,
        cantidad_a_descontar: prod.cantidad
      });
    }

    document.getElementById("modalPDF").style.display = "flex";

  } catch (err) {
    console.error(err);
    alert("Error al procesar el pedido.");
  }
}

function reiniciarPedido() {
  pedidoTemp = [];
  renderCarritoCliente();
  document.getElementById("clienteNombre").value = "";
  document.getElementById("dni").value = "";
  document.getElementById("clienteLocalidad").value = "";
  document.getElementById("busquedaPromo").value = "";
  document.getElementById("categoriaSelect").value = "";
  document.getElementById("productosContainer").innerHTML = "";
  document.getElementById("carritoTotal").textContent = "$0.00";
  document.getElementById("carritoCount").textContent = "0";
  window.scrollTo({ top: 0, behavior: "smooth" });
  pedidoExistenteId = null;
}

function cerrarModalPDF() {
  document.getElementById("modalPDF").style.display = "none";
  reiniciarPedido();
}


// Funci√≥n para abrir el modal de checklist
function abrirControlPedido() {
  document.getElementById("modalPDF").style.display = "none";
  const modalControl = document.getElementById("modalControlPedido");
  const contenedor = document.getElementById("listaControlCheck");
  
  contenedor.innerHTML = ""; // Limpiar contenido previo

  pedidoTemp.forEach((prod, index) => {
    const div = document.createElement("div");
    div.className = "item-control";
    div.innerHTML = `
      <input type="checkbox" id="check-${index}" class="check-preparacion" onchange="validarChecklist()">
      <label for="check-${index}">
        <strong>${prod.cantidad}x</strong> ${prod.nombre}
      </label>
    `;
    contenedor.appendChild(div);
  });

  modalControl.style.display = "flex";
  validarChecklist(); // Inicializar estado del bot√≥n
}

// Funci√≥n para validar si todos los productos est√°n marcados
function validarChecklist() {
  const checkboxes = document.querySelectorAll(".check-preparacion");
  const btnFinalizar = document.getElementById("btnFinalizarControl");
  const todosMarcados = Array.from(checkboxes).every(cb => cb.checked);

  // Aplicar estilo visual a las filas marcadas
  checkboxes.forEach(cb => {
    if (cb.checked) {
      cb.parentElement.classList.add("checked");
    } else {
      cb.parentElement.classList.remove("checked");
    }
  });

  if (todosMarcados && checkboxes.length > 0) {
    btnFinalizar.disabled = false;
    btnFinalizar.style.background = "#27ae60";
    btnFinalizar.style.cursor = "pointer";
    btnFinalizar.textContent = "‚úÖ TODO LISTO - DESCARGAR PDF";
  } else {
    btnFinalizar.disabled = true;
    btnFinalizar.style.background = "#ccc";
    btnFinalizar.style.cursor = "not-allowed";
    btnFinalizar.textContent = "FALTAN PRODUCTOS POR MARCAR";
  }
}

function cerrarControlPedido() {
  document.getElementById("modalControlPedido").style.display = "none";
  reiniciarPedido(); // Opcional: si quieres limpiar todo al cancelar
}

// Funci√≥n especial para descargar y cerrar todo
async function descargarPDFDesdeControl() {
  await descargarPDF(); // Llama a tu funci√≥n existente
  document.getElementById("modalControlPedido").style.display = "none";
}



  
// ================== GENERAR PDF ==================
async function descargarPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  const nombreCliente = (document.getElementById("clienteNombre").value || "").trim() || "Sin nombre";
  const selectLocalidad = document.getElementById("clienteLocalidad");
  const localidad = (selectLocalidad.options[selectLocalidad.selectedIndex]?.text || "Sin localidad").trim();
  const fecha = new Date().toLocaleString("es-AR");
  const dni = (document.getElementById("dni").value || "").trim() || "Sin DNI";

  let ahorroTotal = 0;
  const productos = pedidoTemp.map(p => {
    const subtotal = p.precio * p.cantidad;
    if (p.precio_anterior && p.precio_anterior > p.precio) {
      ahorroTotal += (p.precio_anterior - p.precio) * p.cantidad;
    }
    return [
      p.nombre,
      p.cantidad,
      p.precio_anterior ? `$${p.precio_anterior.toFixed(2)}` : "-",
      `$${p.precio.toFixed(2)}`,
      `$${subtotal.toFixed(2)}`
    ];
  });

  const logoURL = "https://ejbqlejlgprvwzrptojo.supabase.co/storage/v1/object/public/promo_images/logodistribuidora.png";
  const img = new Image();
  img.crossOrigin = "anonymous";
  img.src = logoURL;

  img.onload = () => {
    const pageWidth = doc.internal.pageSize.getWidth();
    doc.addImage(img, 'PNG', (pageWidth - 110) / 2, 10, 110, 35);
    doc.setFontSize(16);
    doc.text("Pedido Realizado", pageWidth / 2, 45, { align: "center" });
    doc.setFontSize(12);
    doc.text(`Cliente: ${nombreCliente}`, 10, 60);
    doc.text(`DNI: ${dni}`, 10, 68);
    doc.text(`Localidad: ${localidad}`, 10, 76);
    doc.text(`Fecha: ${fecha}`, 10, 84);

    doc.autoTable({
      startY: 92,
      head: [["Producto", "Cant.", "P. Ant.", "P. Act.", "Subtotal"]],
      body: productos,
      styles: { fontSize: 10 }
    });

    const finalY = doc.lastAutoTable.finalY || 100;
    doc.setFontSize(14);
    doc.text(`Total: $${pedidoTemp.reduce((acc, p) => acc + p.precio * p.cantidad, 0).toFixed(2)}`, 150, finalY + 12);
    
    if (ahorroTotal > 0) {
      doc.setTextColor(0, 128, 0);
      doc.text(`Ahorro total: $${ahorroTotal.toFixed(2)}`, 10, finalY + 30);
    }

    doc.save(`pedido-${nombreCliente.replace(/\s+/g, '_')}.pdf`);
    cerrarModalPDF();
  };
}

// ================== INICIALIZACI√ìN ==================
window.addEventListener("DOMContentLoaded", () => {
  cargarCategorias();
  cargarLocalidades();
});

// Listener para cerrar modal imagen al click fuera
document.getElementById('modalImagen').addEventListener('click', function(e) {
  if (e.target === this) cerrarModalImagen();
});
</script>
</body>
</html>
